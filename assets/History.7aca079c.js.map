{"version":3,"file":"History.7aca079c.js","sources":["../../src/types/moonraker.ts","../../src/Routes/Moonraker/History.tsx"],"sourcesContent":["import { PointTuple, PositionTuple } from \"./basic\";\n\nexport type MoonrakerUpdateStatus = {\n  [key: string]: unknown;\n};\n\n// TODO: Missing fade details\nexport interface BedMeshStatus {\n  profile_name: string;\n  mesh_min: PointTuple;\n  mesh_max: PointTuple;\n  probed_matrix: Array<Array<number>>; // Actual probed points\n  mesh_matrix: Array<Array<number>>; // Interpolated matrix\n  profiles: {\n    [profile_name: string]: {\n      points: Array<Array<number>>;\n      mesh_params: {\n        min_x: number;\n        max_x: number;\n        min_y: number;\n        max_y: number;\n        x_count: number;\n        y_count: number;\n        mesh_x_pps: number;\n        mesh_y_pps: number;\n        algo: \"lagrange\" | \"bicubic\";\n        tension: number;\n      };\n    };\n  };\n}\n\nexport interface ProbeStatus {\n  last_query: boolean;\n  last_z_result: number;\n}\nexport interface ZCalibrationStatus {\n  last_query: boolean;\n  last_z_offset: number;\n}\n\nexport interface GCodeMoveStatus {\n  speed_factor: number;\n  speed: number;\n  extrude_factor: number;\n  absolute_coordinates: boolean;\n  absolute_extrude: boolean;\n  homing_origin: PositionTuple;\n  position: PositionTuple;\n  gcode_position: PositionTuple;\n}\n\nexport interface DockableProbeStatus {\n  last_time: number;\n  last_state: \"ATTACHED\" | \"DOCKED\" | \"UNKNOWN\";\n}\nexport interface MotionReportStatus {\n  live_position: PositionTuple;\n  live_velocity: number;\n  live_extruder_velocity: number;\n  steppers: string[];\n  trapq: string[];\n}\n\nexport interface ToolheadStatus {\n  homed_axes: \"\" | \"x\" | \"y\" | \"z\" | \"xy\" | \"xz\" | \"yz\" | \"xyz\";\n  axis_minimum: PositionTuple;\n  axis_maximum: PositionTuple;\n  print_time: number;\n  stalls: number;\n  estimated_print_time: number;\n  extruder: string;\n  position: PositionTuple;\n  max_velocity: number;\n  max_accel: number;\n  max_accel_to_decel: number;\n  square_corner_velocity: number;\n}\n\nexport interface ExtruderStatus {\n  temperature: number;\n  target: number;\n  power: number;\n  can_extrude: boolean;\n  pressure_advance: number;\n  smooth_time: number;\n}\n\nexport interface MCU {\n  mcu_version: string;\n  mcu_build_versions: string;\n  mcu_constants: { [key: string]: string | number };\n  last_stats: {\n    mcu_awake: number;\n    mcu_task_avg: number;\n    mcu_task_stddev: number;\n    bytes_write: number;\n    bytes_read: number;\n    bytes_retransmit: number;\n    bytes_invalid: number;\n    send_seq: number;\n    receive_seq: number;\n    retransmit_seq: number;\n    srtt: number;\n    rttvar: number;\n    rto: number;\n    ready_bytes: number;\n    stalled_bytes: number;\n    freq: number;\n  };\n}\nexport interface MachineSystemInfo {\n  python: {\n    version: [number, number, number, string, number];\n    version_string: string;\n  };\n  cpu_info: {\n    cpu_count: number; // 4\n    bits: string; // \"64bit\"\n    processor: string; // \"aarch64\"\n    cpu_desc: string; // \"\"\n    serial_number: string; // \"10000000195cf705\"\n    hardware_desc: string; // \"BCM2835\"\n    model: string; // \"Raspberry Pi 4 Model B Rev 1.4\"\n    total_memory: number; // 3705688\n    memory_units: string; // \"kB\"\n  };\n  sd_info?: {\n    manufacturer_id: string; // \"03\"\n    manufacturer: string; // \"Sandisk\"\n    oem_id: string; // \"5344\"\n    product_name: string; // \"SN128\"\n    product_revision: string; // \"8.0\"\n    serial_number: string; // \"711addbe\"\n    manufacturer_date: string; // \"4/2021\"\n    capacity: string; // \"119.1 GiB\"\n    total_bytes: number; // 127865454592\n  };\n  distribution?: {\n    name: string; // \"Debian GNU/Linux 11 (bullseye)\";\n    id: string; // \"debian\";\n    version: string; // \"11\";\n    version_parts: {\n      major: string; //  \"11\"\n      minor: string; //  \"\"\n      build_number: string; //  \"\"\n    };\n    like: string; // \"\"\n    codename: string; // \"bullseye\"\n    release_info: unknown; // {}\n  };\n  virtualization: {\n    virt_type: \"none\" | string;\n    virt_identifier: \"none\" | string;\n  };\n  network: {\n    [device: string]: {\n      mac_address: string;\n      ip_addresses: Array<{\n        family: \"ipv4\" | \"ipv6\";\n        address: string;\n        is_link_local: boolean;\n      }>;\n    };\n  };\n  // TODO: Add more known values\n  available_services: \"moonraker\" | \"webcamd\" | \"klipper_mcu\" | \"klipper\" | \"KlipperScreen\" | string;\n  service_state: Array<{\n    [service: string]: {\n      // TODO: Add more known values\n      active_state: \"active\" | string;\n      // TODO: Add more known values\n      sub_state: \"running\" | string;\n    };\n  }>;\n}\n\nexport type MoonrakerPrinterInfo = {\n  state: string;\n  state_message: string;\n  hostname: string;\n  software_version: string;\n  cpu_info: string;\n  klipper_path: string;\n  python_path: string;\n  log_file: string;\n  config_file: string;\n};\n\nexport type MoonrakerServerInfo = {\n  klippy_connected: boolean;\n  klippy_state: string;\n  components: string[];\n  failed_components: string[];\n  registered_directories: string[];\n  warnings: string[];\n  websocket_count: number;\n  moonraker_version: string;\n  api_version: [number, number, number];\n  api_version_string: string;\n};\n\nexport type MoonrakerAnnouncement = {\n  entry_id: string;\n  url: string;\n  title: string;\n  description: string;\n  priority: string;\n  date: number;\n  dismissed: boolean;\n  date_dismissed?: null | number;\n  dismiss_wake?: unknown;\n  source: string;\n  feed: string;\n};\n\nexport enum JobStatus {\n  Completed = \"completed\",\n  Cancelled = \"cancelled\",\n  Error = \"error\",\n  Printing = \"printing\",\n  InProgress = \"in_progress\",\n  Server_Exit = \"server_exit\",\n  Klippy_Shutdown = \"klippy_shutdown\",\n  Klippy_Disconnect = \"klippy_disconnect\",\n}\n\nexport type MoonrakerJob = {\n  job_id: string;\n  exists: boolean;\n  end_time: number;\n  filament_used: number;\n  filename: string;\n  metadata: { [key: string]: unknown };\n  print_duration: number;\n  status: JobStatus;\n  start_time: number;\n  total_duration: number;\n};\n\nexport type MoonrakerExcludeObjectStatus = {\n  objects: Array<{\n    name: string;\n    center: PointTuple;\n    polygon: Array<PointTuple>;\n  }>;\n  excluded_objects: Array<string>;\n  current_object: null | string;\n};\n\nexport type MoonrakerProcStats = {\n  cpu_temp: number;\n  moonraker_stats: {\n    time: number;\n    cpu_usage: number;\n    memory: number;\n    mem_units: string;\n  };\n  throttled_state?: {\n    bits: number;\n    flags: string[];\n  };\n  network: {\n    [device_name: string]: {\n      rx_bytes: number;\n      tx_bytes: number;\n      bandwidth: number;\n    };\n  };\n  system_cpu_usage: { [key: string]: number };\n  system_memory: {\n    total: number;\n    available: number;\n    used: number;\n  };\n  websocket_connections: number;\n};\n\nexport type MoonrakerHistoryTotals = {\n  total_jobs: number;\n  total_time: number;\n  total_print_time: number;\n  total_filament_used: number;\n  longest_job: number;\n  longest_print: number;\n};\n","import { produce } from \"immer\";\nimport { useEffect, useState } from \"react\";\nimport { BsCheckCircle, BsClock, BsXCircle } from \"react-icons/bs\";\nimport { TbAlertTriangle } from \"react-icons/tb\";\n\nimport useMoonraker from \"../../Context/Moonraker\";\nimport { JobStatus, MoonrakerHistoryTotals, MoonrakerJob } from \"../../types\";\nimport cx from \"../../utils/cx\";\nimport { useRpcHandler } from \"../../utils/jsonrpc\";\n\nfunction ApproxLength({ length }: { length: number }) {\n  return (\n    <span>\n      {length > 100000\n        ? `${(length / 100000).toFixed(1)} km`\n        : length > 100\n        ? `${(length / 1000).toFixed(1)} m`\n        : length > 10\n        ? `${(length / 10).toFixed(1)}cm`\n        : `${length.toFixed(1)}mm`}\n    </span>\n  );\n}\nfunction ApproxDuration({ duration }: { duration: number }) {\n  return (\n    <span>\n      {duration > 3600 * 48\n        ? `${(duration / (3600 * 24)).toFixed(1)} days`\n        : duration > 3600\n        ? `${(duration / 3600).toFixed(1)} h`\n        : duration > 60\n        ? `${(duration / 60).toFixed(1)} min`\n        : `${duration.toFixed(1)}s`}\n    </span>\n  );\n}\n\nexport default function History() {\n  const { rpc } = useMoonraker();\n  const [history, setHistory] = useState<Array<MoonrakerJob>>([]);\n  const [totals, setTotals] = useState<null | MoonrakerHistoryTotals>(null);\n\n  useEffect(() => {\n    if (!rpc) return;\n\n    rpc.call(\"server.history.totals\").then(({ job_totals }) => {\n      setTotals(job_totals);\n    });\n    rpc.call(\"server.history.list\").then(({ count, jobs }) => {\n      setHistory(jobs);\n      console.log(count, jobs.length);\n    });\n  }, [rpc, setHistory, setTotals]);\n\n  useRpcHandler(rpc, \"notify_history_changed\", ([{ action, job }]) => {\n    console.log(action, job);\n\n    setHistory(\n      produce((draft) => {\n        draft.unshift(job);\n      })\n    );\n  });\n\n  return (\n    <section>\n      <h2 className={cx(\"text-xl\")}>History</h2>\n\n      <article className={cx(\"flex\", \"flex-row\")}>\n        {totals && (\n          <>\n            <div className={cx(\"card\", \"bg-base-100\", \"dark:bg-base-300\", \"shadow-xl\", \"mr-1\")}>\n              <div className={cx(\"card-body\")}>\n                <h2 className={cx(\"card-title\")}>Longest Job</h2>\n                <ApproxDuration duration={totals.longest_job} />\n              </div>\n            </div>\n\n            <div className={cx(\"card\", \"bg-base-100\", \"dark:bg-base-300\", \"shadow-xl\", \"mr-1\")}>\n              <div className={cx(\"card-body\")}>\n                <h2 className={cx(\"card-title\")}>Longest Print</h2>\n                <ApproxDuration duration={totals.longest_print} />\n              </div>\n            </div>\n\n            <div className={cx(\"card\", \"bg-base-100\", \"dark:bg-base-300\", \"shadow-xl\", \"mr-1\")}>\n              <div className={cx(\"card-body\")}>\n                <h2 className={cx(\"card-title\")}>Filament Used</h2>\n                <ApproxLength length={totals.total_filament_used} />\n              </div>\n            </div>\n\n            <div className={cx(\"card\", \"bg-base-100\", \"dark:bg-base-300\", \"shadow-xl\", \"mr-1\")}>\n              <div className={cx(\"card-body\")}>\n                <h2 className={cx(\"card-title\")}>Total Jobs</h2>\n                {totals.total_jobs}\n              </div>\n            </div>\n\n            <div className={cx(\"card\", \"bg-base-100\", \"dark:bg-base-300\", \"shadow-xl\", \"mr-1\")}>\n              <div className={cx(\"card-body\")}>\n                <h2 className={cx(\"card-title\")}>Print Time</h2>\n                <ApproxDuration duration={totals.total_print_time} />\n              </div>\n            </div>\n\n            <div className={cx(\"card\", \"bg-base-100\", \"dark:bg-base-300\", \"shadow-xl\", \"mr-1\")}>\n              <div className={cx(\"card-body\")}>\n                <h2 className={cx(\"card-title\")}>Total Time</h2>\n                <ApproxDuration duration={totals.total_time} />\n              </div>\n            </div>\n          </>\n        )}\n      </article>\n      <table className={cx(\"table\", \"table-compact\", \"text-sm\")}>\n        <thead>\n          <tr>\n            <th>Filename</th>\n            <th>Start</th>\n            <th>Status</th>\n            <th>Total Time</th>\n            <th>Print Time</th>\n            <th>Filament Used</th>\n          </tr>\n        </thead>\n        <tbody className={cx(\"text-sm\")}>\n          {history.map((job) => (\n            <tr key={job.job_id}>\n              <td className={cx(\"line-clamp-1\")}>{job.filename}</td>\n              <td>{new Date(job.start_time * 1000).toLocaleString()}</td>\n              <td title={job.status}>\n                {(() => {\n                  switch (job.status) {\n                    case JobStatus.Printing:\n                    case JobStatus.InProgress:\n                      return <BsClock size=\"1.5rem\" className={cx(\"fill-primary\", \"-m-0.5\")} />;\n                    case JobStatus.Completed:\n                      return <BsCheckCircle size=\"1.5rem\" className={cx(\"fill-success\", \"-m-0.5\")} />;\n                    case JobStatus.Cancelled:\n                      return <BsXCircle size=\"1.5rem\" className={cx(\"fill-info\", \"-m-0.5\")} />;\n                    case JobStatus.Error:\n                    case JobStatus.Server_Exit:\n                    case JobStatus.Klippy_Shutdown:\n                    case JobStatus.Klippy_Disconnect:\n                      return <TbAlertTriangle size=\"1.5rem\" className={cx(\"fill-error\", \"-m-0.5\")} />;\n                  }\n                })()}\n              </td>\n              <td>\n                <ApproxDuration duration={job.total_duration} />\n              </td>\n              <td>\n                <ApproxDuration duration={job.print_duration} />\n              </td>\n              <td>\n                <ApproxLength length={job.filament_used} />\n              </td>\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </section>\n  );\n}\n"],"names":["length","toFixed","duration","rpc","useMoonraker","history","setHistory","useState","totals","setTotals","useEffect","call","then","job_totals","count","jobs","log","action","job","produce","draft","unshift","_jsx","cx","_jsxs","_Fragment","longest_job","longest_print","total_filament_used","total_jobs","total_print_time","total_time","map","filename","Date","start_time","toLocaleString","status","JobStatus","Printing","InProgress","Completed","Cancelled","Error","Server_Exit","Klippy_Shutdown","Klippy_Disconnect","total_duration","print_duration","filament_used","job_id"],"mappings":"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"}